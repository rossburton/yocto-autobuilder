'''
Created on Mar 17, 2013

__author__ = "Elizabeth 'pidge' Flanagan"
__copyright__ = "Copyright 2012-2013, Intel Corp."
__credits__ = ["Elizabeth Flanagan"]
__license__ = "GPL"
__version__ = "2.0"
__maintainer__ = "Elizabeth Flanagan"
__email__ = "elizabeth.flanagan@intel.com"
'''

from buildbot.steps.shell import ShellCommand
from twisted.python import log
import os, datetime 
from autobuilder.config import *

class PublishLayerTarballs(ShellCommand):
    haltOnFailure = False 
    flunkOnFailure = True 
    name = "Publishing Layer Tarballs" 
    def __init__(self, factory, layername, workdir, argdict=None, **kwargs):
        self.factory = factory
        self.layername = layername
        self.workdir = workdir
        self.description = "Publishing " + layername + " tarball"
        self.slavedir=SLAVEBASEDIR
        for k, v in argdict.iteritems():
            setattr(self, k, v)
        self.timeout = 100000
        kwargs['timeout']=self.timeout
        ShellCommand.__init__(self, **kwargs)

    def start(self):
        DEST=self.getProperty("DEST")
        buildername=self.getProperty("buildername")
        revision = ""
        if str(os.environ.get('PUBLISH_BUILDS')) == "True":
            if self.getProperty("custom_release_me_"+buildername):
                revision=self.getProperty("custom_release_name_"+buildername)
            elif self.getProperty("got_revision_"+self.layername):
                revision=self.getProperty("got_revision_"+self.layername)
            if revision is not "":
                self.basedir=os.path.join(os.path.join(os.path.join(
                                            self.slavedir, buildername), self.workdir))
                command = " git archive --format=tar HEAD "
                command = command + "--prefix=" + self.layername + "-" + revision + "/"
                command = command + " | gzip > " + self.layername + "-" + revision + ".tar.gz; "
                command = command + " git archive --format=tar HEAD "
                command = command + "--prefix=" + self.layername + "-" + revision + "/"
                command = command + " | bzip2 -c > " + self.layername + "-" + revision + ".tar.bz2; "
                command = command + "md5sum " + self.layername + "-" + revision + ".tar.bz2 >> "
                command = command + self.layername + "-" + revision + ".tar.bz2.md5sum; "
                command = command + "md5sum " + self.layername + "-" + revision + ".tar.gz >> "
                command = command + self.layername + "-" + revision + ".tar.gz.md5sum; "
                command = command + "mkdir -p " + DEST + "; rsync -av "
                command = command + self.layername + "-" + revision +".tar.* " + DEST
                self.command=command
            else:
                self.command="echo 'No revision found. Skipping tarball'"
            ShellCommand.start(self)
